<!DOCTYPE html><html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CIE Grade Boundaries</title><!-- ─── PERFORMANCE HINTS ─── -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="preconnect" href="https://cdn.datatables.net" />
<link rel="preconnect" href="https://code.jquery.com" />

<!-- Tailwind (small – safe to defer) -->
<script src="https://cdn.tailwindcss.com" defer></script>

<!-- PapaParse (needed before fetching/parsing CSV) -->
<script
  src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
  defer
></script>

<!-- DataTables CSS -->
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"
/>

<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to bottom, #def2f1, #ffffff);
  }
  header {
    background-color: #3aafa9;
  }
  nav a:hover {
    color: #ffffff;
    border-bottom: 2px solid #feffff;
  }
  table.dataTable thead th {
    background-color: #3aafa9;
    color: white;
  }
  table.dataTable tbody tr:hover {
    background-color: #dff6f5;
  }

  /* ─── MOBILE-FRIENDLY TABLE ─── */
  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  table.dataTable th,
  table.dataTable td {
    padding: 0.25rem 0.5rem !important;
    line-height: 1.2;
  }
  table.dataTable th {
    font-size: clamp(0.875rem, 2vw, 1.25rem);
    white-space: nowrap;
  }
  table.dataTable td {
    font-size: clamp(0.75rem, 1.2vw, 1rem);
  }
  table.dataTable {
    width: 100%;
    max-width: 1000px;
    margin: 0 auto;
  }
  @media (max-width: 400px) {
    table.dataTable th,
    table.dataTable td {
      padding: 0.125rem 0.25rem !important;
    }
  }

  /* ─── RESPONSIVE CHART ─── */
  .chart-container {
    position: relative;
    width: 100%;
    /* Even taller graph */
    min-height: 450px;
    height: 70vw; /* scales with screen width on mobiles */
    max-height: 800px; /* avoids being massive on desktops */
  }
  .chart-container canvas {
    position: absolute;
    inset: 0;
    width: 100% !important;
    height: 100% !important;
  }
</style>

  </head>  <body class="text-gray-800 flex flex-col min-h-screen">
    <header class="text-white text-center py-6 shadow-lg">
      <h1 class="text-3xl sm:text-4xl font-bold">
        Cambridge International Grade Boundaries
      </h1>
      <nav class="mt-4">
        <a href="index.html" class="mx-4 text-base sm:text-lg hover:text-white transition">
          Home</a
        >
        <a href="Edexcel.html" class="mx-4 text-base sm:text-lg hover:text-white transition"
          >Edexcel</a
        >
        <a href="OxfordAqa.html" class="mx-4 text-base sm:text-lg hover:text-white transition"
          >Oxford&nbsp;AQA</a
        >
      </nav>
    </header><main class="flex-1 w-full px-4">
  <section class="bg-white rounded-lg shadow-md p-6 w-full max-w-6xl mx-auto">
    <h2 class="text-2xl font-semibold mb-4">
      Cambridge International Grade Boundaries
    </h2>

    <!-- ===== TABLE ===== -->
    <div class="table-wrapper mb-6">
      <table
        id="CIETable"
        class="display nowrap responsive w-full"
        aria-describedby="grade-boundaries-caption"
      >
        <caption id="grade-boundaries-caption" class="sr-only">
          Cambridge grade boundaries per unit / component code
        </caption>
        <thead>
          <tr></tr>
        </thead>
        <!-- No <tbody> needed—DataTables will populate it -->
      </table>
    </div>

    <!-- ===== CSV DOWNLOAD ===== -->
    <div class="text-right my-4">
      <button
        id="downloadCSV"
        class="bg-[#3aafa9] text-white px-4 py-2 rounded hover:bg-[#2b7a78] transition"
      >
        Download CSV
      </button>
    </div>

    <!-- ===== CONTROLS ===== -->
    <div id="cie-controls" class="flex flex-wrap gap-4 mb-6 items-center">
      <label for="cieSubjectSearch" class="font-semibold"
        >Subject&nbsp;Code:</label
      >
      <input
        type="text"
        id="cieSubjectSearch"
        placeholder="e.g. 9709"
        class="border rounded px-2 py-1 w-32 sm:w-auto"
        list="cieSubjectList"
      />
      <datalist id="cieSubjectList"></datalist>

      <label for="cieComponentSearch" class="font-semibold"
        >Component&nbsp;(for&nbsp;graph):</label
      >
      <input
        type="text"
        id="cieComponentSearch"
        placeholder="select component"
        class="border rounded px-2 py-1 w-24 sm:w-32"
        list="cieComponentList"
        disabled
      />
      <datalist id="cieComponentList"></datalist>
    </div>

    <!-- ===== CHART ===== -->
    <div class="chart-container">
      <canvas id="CIEChart"></canvas>
    </div>
  </section>
</main>

<footer class="bg-[#3aafa9] text-white text-center py-4 mt-10">
  <p>
    Database provided by
    <a
      href="https://github.com/ChessMastermind"
      class="underline hover:text-gray-200"
      >ChessMastermind</a
    >
  </p>
</footer>

<!-- ─── PAGE SCRIPT ─── -->
<script defer>
  /**
   * Helper: dynamically load a script by URL and resolve when loaded
   */
  const loadScript = (src) =>
    new Promise((res) => {
      const s = document.createElement("script");
      s.src = src;
      s.onload = res;
      document.body.appendChild(s);
    });

  window.addEventListener("DOMContentLoaded", () => {
    fetch("CIE.csv")
      .then((r) => r.text())
      .then((csvText) =>
        new Promise((resolve) => {
          Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            worker: true, // offload parsing
            complete: ({ data }) => resolve([data, csvText]),
          });
        })
      )
      .then(async ([parsed, csvText]) => {
        // 1) Load jQuery, DataTables, and Chart.js after parsing CSV
        await loadScript("https://code.jquery.com/jquery-3.6.0.min.js");
        await Promise.all([
          loadScript(
            "https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"
          ),
          loadScript(
            "https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"
          ),
          loadScript("https://cdn.jsdelivr.net/npm/chart.js"),
        ]);

        initPage(parsed, csvText);
      })
      .catch((err) => {
        console.error(err);
        const placeholder = `<tbody><tr><td colspan="10" class="text-center py-4">Failed to load data.</td></tr></tbody>`;
        document.getElementById("CIETable").innerHTML = placeholder;
      });
  });

  /**
   * Main initialization: hand DataTables the parsed array, then set up filters, chart, and CSV download
   */
  function initPage(parsed, csvText) {
    const tableEl = $("#CIETable");

    // ─── 1) Build columns array from CSV headers ───
    const headers = Object.keys(parsed[0] || {});
    const dtColumns = headers.map((h) => ({
      data: h,
      title: h,
    }));

    // ─── 2) Initialize DataTables directly from JS data ───
    const dataTable = tableEl.DataTable({
      data: parsed, // use the entire array of parsed objects
      columns: dtColumns,
      responsive: true,
      autoWidth: false,
      deferRender: true,
      pageLength: 10,
    });

    // ─── 2a) Add optional component search next to default search bar ───
    const componentColIdx = headers.findIndex((h) =>
      ["Component", "component", "ComponentCode", "component_code"].includes(h)
    );
    if (componentColIdx !== -1) {
      // Build datalist of unique components
      const compSet = new Set();
      parsed.forEach((row) => {
        const comp =
          row["Component"] ||
          row["component"] ||
          row["ComponentCode"] ||
          row["component_code"] ||
          "";
        if (comp) compSet.add(comp);
      });

      // Insert label + input next to the global filter
      const filterDiv = $("#CIETable_filter");
      const compHtml = `
        <label style="margin-left:1rem; font-weight:600;">
          Component:&nbsp;
          <input type="text" id="componentTableSearch" list="cieComponentTableList" placeholder="component" class="border rounded px-2 py-1 w-24 sm:w-32" />
        </label>`;
      filterDiv.append(compHtml);
      $("body").append('<datalist id="cieComponentTableList"></datalist>');
      const dl = $("#cieComponentTableList");
      [...compSet].sort().forEach((c) => dl.append(`<option value="${c}"></option>`));

      // Hook search
      $("#componentTableSearch").on("input", function () {
        dataTable.column(componentColIdx).search(this.value).draw();
      });
    }

    // ─── 3) Prepare data structure: subject → component → session → grades ───
    const cieDataBySubject = {};
    const gradeList = ["a*", "a", "b", "c", "d", "e"];
    const monthOrder = {
      Jan: 1,
      Feb: 2,
      Mar: 3,
      Apr: 4,
      May: 5,
      Jun: 6,
      Jul: 7,
      Aug: 8,
      Sep: 9,
      Oct: 10,
      Nov: 11,
      Dec: 12,
    };

    parsed.forEach((row) => {
      // Normalize field names (some CSVs use different headers)
      const sessionRaw =
        row["Series"] || row["session"] || row["Session"] || "";
      const subject = row["SubjectCode"] || row["code"] || row["subject"] || "";
      const component =
        row["Component"] ||
        row["component"] ||
        row["ComponentCode"] ||
        row["component_code"] ||
        "";

      if (!sessionRaw || !subject) return;

      // Standardize session format to "YYYY MMM"
      let session = sessionRaw.trim();
      if (!/^\d{4}\s+[A-Za-z]{3}$/i.test(session)) {
        // e.g. "Jun-2024" or "Jun 2024" → "2024 Jun"
        const parts = session.replace("-", " ").split(/\s+/);
        if (parts.length === 2) {
          const [mon, yr] = parts;
          session = `${yr} ${mon.substring(0, 3)}`;
        }
      }

      const compKey = component || "ALL";
      cieDataBySubject[subject] ??= {};
      cieDataBySubject[subject][compKey] ??= {};
      cieDataBySubject[subject]["ALL"] ??= {};

      cieDataBySubject[subject][compKey][session] ??= {};
      cieDataBySubject[subject]["ALL"][session] ??= {};

      gradeList.forEach((g) => {
        // CSV might use uppercase grade headers or lowercase
        const rawVal = row[g.toUpperCase()] ?? row[g] ?? "";
        const val = parseFloat(rawVal);
        if (!isNaN(val)) {
          cieDataBySubject[subject][compKey][session][g] = val;
          cieDataBySubject[subject]["ALL"][session][g] = val;
        }
      });

      const maxMarkRaw = row["MaxMark"] || row["max_mark"] || "";
      const maxMark = parseFloat(maxMarkRaw);
      if (!isNaN(maxMark)) {
        cieDataBySubject[subject][compKey][session]["max_mark"] = maxMark;
        cieDataBySubject[subject]["ALL"][session]["max_mark"] = maxMark;
      }
    });

    // ─── 4) Populate Subject & Component datalists ───
    const subjectInput = document.getElementById("cieSubjectSearch");
    const componentInput = document.getElementById("cieComponentSearch");
    const subjectList = document.getElementById("cieSubjectList");
    const componentList = document.getElementById("cieComponentList");

    Object.keys(cieDataBySubject)
      .sort()
      .forEach((code) => {
        const opt = document.createElement("option");
        opt.value = code;
        subjectList.appendChild(opt);
      });

    function populateComponents(subject) {
      componentList.innerHTML = "";
      componentInput.value = "";
      componentInput.disabled = true;
      if (!subject || !cieDataBySubject[subject]) {
        return;
      }
      const comps = Object.keys(cieDataBySubject[subject])
        .filter((c) => c !== "ALL")
        .sort();
      if (!comps.length) return;
      componentInput.disabled = false;
      comps.forEach((comp) => {
        const opt = document.createElement("option");
        opt.value = comp;
        componentList.appendChild(opt);
      });
      // Auto-select first component to encourage valid graph input
      componentInput.value = comps[0];
    }

    // ─── 5) Configure & update the Chart ───
    const gradeColors = {
      "a*": "#2ECC71",
      a: "#F4A261",
      b: "

